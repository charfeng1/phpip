import{d as H,r as d}from"./app-C8_l7NaG.js";import"./alpine-BkKOMYu4.js";function U(){const s=new URL(window.location.href),m=document.getElementById("filterFields"),g=document.getElementById("grace"),u=document.getElementById("selectAll"),f=document.getElementById("tabsGroup"),p=document.getElementById("clearFilters"),w=document.getElementById("doneRenewals"),E=document.getElementById("callRenewals"),h=document.getElementById("renewalsSent"),y=document.getElementById("renewalsExport"),R=document.getElementById("renewalsInvoiced"),v=document.getElementById("invoicesPaid"),A=document.getElementById("instructedRenewals"),k=document.getElementById("lastReminderRenewals"),I=document.getElementById("reminderRenewals"),L=document.getElementById("abandonRenewals"),B=document.getElementById("lapsedRenewals"),b=document.getElementById("lapsingRenewals"),P=document.getElementById("sendLapsedRenewals"),S=document.getElementById("xmlRenewals");function x(){window.history.pushState("","phpIP",s),d(s,"renewalList")}m&&m.addEventListener("input",H(e=>{e.target.matches(".form-control")&&(e.target.value.length===0?s.searchParams.delete(e.target.name):s.searchParams.set(e.target.name,e.target.value),s.searchParams.delete("page"),x())},500)),g&&(g.onchange=e=>{e.target.checked?s.searchParams.set("grace_period","1"):s.searchParams.delete("grace_period"),x()}),u&&(u.onchange=e=>{const t=e.target.checked,n=document.getElementsByClassName("clear-ren-task");for(const i of n)i.checked=t}),f&&f.addEventListener("click",function(e){s.searchParams.delete("step"),s.searchParams.delete("invoice_step"),s.searchParams.delete("page"),e.target.hasAttribute("data-step")&&s.searchParams.set("step",e.target.dataset.step),e.target.hasAttribute("data-invoice_step")&&s.searchParams.set("invoice_step",e.target.dataset.invoice_step),window.history.pushState("","phpIP",s),d(s,"renewalList")}),p&&(p.onclick=()=>{for(const e of s.searchParams.keys())e!="step"&&e!="invoice_step"&&s.searchParams.delete(e);window.location.href=s.href}),w&&w.addEventListener("click",function(e){a(e.target,"resetting","/renewal/done")}),E&&E.addEventListener("click",function(e){a(e.target,"call","/renewal/call/1")}),h&&h.addEventListener("click",function(e){a(e.target,"call","/renewal/call/0")}),y&&(y.onclick=e=>{const t="/renewal/export";e.preventDefault(),window.location.href=t}),R&&R.addEventListener("click",function(e){a(e.target,"invoiced","/renewal/invoice/0")}),v&&(v.onclick=e=>{a(e.target,"paid","/renewal/paid")}),A&&A.addEventListener("click",function(e){a(e.target,"for payment","/renewal/topay")}),k&&k.addEventListener("click",function(e){a(e.target,"last call","/renewal/lastcall")}),I&&I.addEventListener("click",function(e){a(e.target,"reminder","/renewal/reminder")}),L&&L.addEventListener("click",function(e){a(e.target,"abandon renewals","/renewal/abandon")}),B&&B.addEventListener("click",function(e){a(e.target,"lapsed renewals","/renewal/lapsing")}),b&&b.addEventListener("click",function(e){a(e.target,"lapsed renewals","/renewal/lapsing")}),P&&P.addEventListener("click",function(e){a(e.target,"lapse communications sent","/renewal/closing")});const C=document.getElementById("invoiceRenewals");if(window.appConfig?.renewal?.invoice?.backend==="dolibarr"&&C&&C.addEventListener("click",function(e){a(e.target,"invoicing","/renewal/invoice/1")}),window.appConfig?.renewal?.general?.receipt_tabs){const e=document.getElementById("receiptRenewals");e&&e.addEventListener("click",function(n){a(n.target,"registering receipt","/renewal/receipt")});const t=document.getElementById("sendReceiptsRenewals");t&&t.addEventListener("click",function(n){a(n.target,"closing renewals","/renewal/closing")})}async function a(e,t,n){e.insertAdjacentHTML("afterbegin",'<span class="loading loading-spinner loading-sm"></span>');const i=N();let c;if(i.length===0){const r=document.getElementById("Untildate").value;if(!r){alert("No renewals selected for "+t);const _=e.querySelector(".loading");_&&_.remove();return}const O=document.getElementById("Fromdate").value;c=JSON.stringify({begin:O,end:r})}else c=JSON.stringify({task_ids:i});const l=new URL(window.location.href);await q(c,n).catch(r=>alert(r)),window.history.pushState("","phpIP",l),d(l,"renewalList");const o=e.querySelector(".loading");o&&o.remove()}function q(e,t){return new Promise(function(n,i){const c=new XMLHttpRequest;c.open("POST",t,!0),c.setRequestHeader("Content-type","application/json; charset=utf-8"),c.setRequestHeader("X-CSRF-TOKEN",document.head.querySelector("[name=csrf-token]").content),c.send(e),c.onload=function(){this.status===200&&n(JSON.parse(this.responseText).success),this.status===419&&i("Token expired. Refresh the page"),this.status===404?i("No email template found - check that your templates match your client's language"):i("Something went wrong")}})}S&&S.addEventListener("click",function(){const e=N();if(e.length===0){alert("No renewals selected for order");return}const t=JSON.stringify({task_ids:e,clear:!1}),n=new XMLHttpRequest;n.open("POST","/renewal/order",!0),n.setRequestHeader("Content-Type","application/json; charset=utf-8"),n.setRequestHeader("X-CSRF-TOKEN",document.head.querySelector("[name=csrf-token]").content),n.send(t),n.onload=function(i){if(this.status==200){const c=n.getResponseHeader("Content-Disposition").split("filename=")[1],l=new File([n.response],c,{type:n.getResponseHeader("Content-Disposition")}),o=document.createElement("a");o.href=window.URL.createObjectURL(l),o.download=c,document.body.appendChild(o),o.click(),document.body.removeChild(o)}else this.status==501&&alert(JSON.parse(this.responseText).error)}});function N(){const e=new Array,t=document.getElementsByClassName("clear-ren-task");for(const n of t)n.checked&&e.push(n.getAttribute("id"));return e}}export{U as initRenewalIndex};
