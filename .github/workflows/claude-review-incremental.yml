name: Claude Incremental Review

on:
  pull_request:
    types: [synchronize]

jobs:
  # Wait for tests to pass first
  wait-for-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for tests workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: tests
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 30

  claude-incremental-review:
    needs: wait-for-tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch for comparison
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Get PR diff info
        id: diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "commit_range=${BASE_SHA}...${HEAD_SHA}" >> $GITHUB_OUTPUT

      - name: Run Claude Incremental Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: 'coderabbitai[bot]'
          additional_permissions: |
            actions: read
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            COMMIT RANGE: ${{ steps.diff.outputs.commit_range }}

            This is an INCREMENTAL review. New commits have been pushed to this PR.

            Please:
            1. Use `gh pr view ${{ github.event.pull_request.number }} --comments` to see previous review comments
            2. Use `gh pr diff ${{ github.event.pull_request.number }}` to see the current changes
            3. Use `git log --oneline ${{ steps.diff.outputs.commit_range }}` to see recent commits
            4. Check if previous review feedback has been addressed
            5. Provide feedback on any remaining issues or new concerns

            Focus on:
            - Whether previous review feedback was addressed
            - Any new issues introduced in the latest changes
            - Code quality of the new changes only

            Do NOT repeat feedback that was already given. Only comment on new or unresolved issues.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: '--model claude-opus-4-5-20251101 --max-turns 10 --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(git log:*),Bash(git diff:*)"'
